<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrazione Parametri Calcio</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Stile aggiuntivo per rendere la tabella più compatta */
        input[type="date"], input[type="number"] {
            width: 100%;
            padding: 0.5rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
        }
        input[type="number"] {
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans p-4">

    <div class="max-w-7xl mx-auto p-6 bg-white rounded-xl shadow-lg">
        <h1 class="text-3xl font-bold mb-6 text-center text-blue-600">Registrazione Parametri Giocatori</h1>

        <!-- Controlli e messaggi -->
        <div class="flex flex-col sm:flex-row items-center justify-between mb-6 space-y-4 sm:space-y-0 sm:space-x-4">
            <div class="flex items-center space-x-2">
                <label for="date-input" class="text-gray-600 font-semibold">Data:</label>
                <input type="date" id="date-input" class="p-2 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <div class="flex space-x-2">
                <button id="save-local-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-300 ease-in-out">
                    Salva in Locale
                </button>
                <button id="download-local-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-300 ease-in-out">
                    Scarica Locale
                </button>
                <button id="send-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-300 ease-in-out">
                    Invia a Google Sheets
                </button>
            </div>
        </div>

        <!-- Message Box -->
        <div id="message-box" class="hidden p-4 mb-4 text-sm font-semibold rounded-lg" role="alert"></div>

        <!-- Tabella dei parametri -->
        <div class="overflow-x-auto shadow-md rounded-lg">
            <table class="min-w-full table-auto border-collapse text-sm">
                <thead class="bg-blue-500 text-white">
                    <tr id="parameter-row" class="text-center"></tr>
                </thead>
                <tbody id="player-rows" class="divide-y divide-gray-200"></tbody>
            </table>
        </div>
    </div>

    <script>
        // --- Inizio della Logica JavaScript ---

        // Dati dei giocatori e dei parametri forniti
        const players = [
            "AGRIGOROAEI", "AIT", "ARCIDIACONO", "BARUZZI", "BENALLAL", "BUSHI", "CENTANNI",
            "FALZONI", "FARINA", "FORESTIERO", "GALLALA", "GEMINIANI", "GNOFFO", "GRANO",
            "GRECA", "GUEYE", "IANIGRO", "MASHA", "MHILLAJ", "NDOJ", "ZITOUNI"
        ];
        const parameters = [
            "balzo_alto", "balzo_avanti", "speed_5", "speed_20", "speed_30", "agility",
            "cooper_6", "cooper_12", "navetta_15", "gacon", "height", "weight", "rpe",
            "recovery", "fatigue", "attendance"
        ];

        // Riferimenti agli elementi HTML
        const dateInput = document.getElementById('date-input');
        const parameterRow = document.getElementById('parameter-row');
        const playerRows = document.getElementById('player-rows');
        const saveLocalBtn = document.getElementById('save-local-btn');
        const downloadLocalBtn = document.getElementById('download-local-btn');
        const sendBtn = document.getElementById('send-btn');
        const messageBox = document.getElementById('message-box');

        // Imposta la data di oggi come predefinita
        dateInput.value = new Date().toISOString().substring(0, 10);

        // --- Funzioni per l'interfaccia utente ---

        /**
         * Mostra un messaggio di notifica all'utente.
         * @param {string} message - Il testo del messaggio.
         * @param {string} type - Il tipo di messaggio ('success', 'error', 'info').
         */
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.className = `p-4 mb-4 text-sm font-semibold rounded-lg text-white ${
                type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' :
                'bg-blue-500'
            }`;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000); // Nasconde il messaggio dopo 5 secondi
        }

        // --- Generazione dinamica della tabella ---

        /**
         * Genera l'intestazione della tabella con i nomi dei parametri.
         */
        function createTableHeaders() {
            // Aggiunge la cella per i nomi dei giocatori
            const playerHeaderCell = document.createElement('th');
            playerHeaderCell.textContent = 'Giocatore';
            playerHeaderCell.className = 'py-3 px-2 text-left';
            parameterRow.appendChild(playerHeaderCell);

            // Aggiunge una cella per ogni parametro
            parameters.forEach(param => {
                const th = document.createElement('th');
                th.textContent = param;
                th.className = 'py-3 px-2';
                parameterRow.appendChild(th);
            });
        }

        /**
         * Genera le righe della tabella con i campi di input.
         */
        function createTableRows() {
            players.forEach(player => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';

                // Cella per il nome del giocatore
                const playerNameCell = document.createElement('td');
                playerNameCell.textContent = player;
                playerNameCell.className = 'px-2 py-1 font-medium text-gray-900';
                tr.appendChild(playerNameCell);

                // Celle con input numerico per ogni parametro
                parameters.forEach(param => {
                    const td = document.createElement('td');
                    td.className = 'px-2 py-1';
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.min = '0';
                    input.id = `${player}-${param}`;
                    input.className = 'block';
                    input.placeholder = '0';
                    td.appendChild(input);
                    tr.appendChild(td);
                });
                playerRows.appendChild(tr);
            });
        }

        // Crea la tabella all'avvio
        createTableHeaders();
        createTableRows();


        // --- Gestione dati ---

        /**
         * Raccoglie tutti i dati inseriti dalla tabella e li formatta.
         * @returns {Array<Object>} Un array di oggetti dati.
         */
        function collectData() {
            const data = [];
            const selectedDate = dateInput.value;

            if (!selectedDate) {
                showMessage("Seleziona una data per registrare i dati.", 'error');
                return null;
            }

            // Converte la data da YYYY-MM-DD a DD-MM-YYYY
            const formattedDate = selectedDate.split('-').reverse().join('/');
            
            // Ottiene l'ora corrente e la formatta
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const formattedTime = `${hours}:${minutes}:${seconds}`;

            // Combina data e ora
            const dataOra = `${formattedDate}, ${formattedTime}`;

            players.forEach(player => {
                parameters.forEach(parameter => {
                    const input = document.getElementById(`${player}-${parameter}`);
                    const value = input.value;
                    if (value) { // Includi solo i campi con valori inseriti
                        data.push({
                            player: player,
                            date: formattedDate, // Usa la data formattata
                            parameter: parameter,
                            paramType: parameter, // Aggiunto il nuovo campo
                            dataOra: dataOra, // Aggiunto il nuovo campo con data e ora
                            value: value
                        });
                    }
                });
            });
            return data;
        }

        // --- Funzioni per il salvataggio locale e il download ---

        /**
         * Salva i dati correnti nel localStorage.
         */
        function saveToLocal() {
            const data = collectData();
            if (data && data.length > 0) {
                try {
                    const existingData = JSON.parse(localStorage.getItem('football-data')) || [];
                    existingData.push(...data);
                    localStorage.setItem('football-data', JSON.stringify(existingData));
                    showMessage("Dati salvati in locale con successo!", 'success');
                } catch (e) {
                    console.error("Errore nel salvataggio in localStorage:", e);
                    showMessage("Errore nel salvataggio dei dati.", 'error');
                }
            } else {
                showMessage("Nessun dato da salvare.", 'info');
            }
        }

        /**
         * Scarica i dati salvati in locale come file CSV.
         */
        function downloadData() {
            try {
                const data = JSON.parse(localStorage.getItem('football-data')) || [];
                if (data.length === 0) {
                    showMessage("Nessun dato salvato in locale da scaricare.", 'info');
                    return;
                }

                let csvContent = "player,date,parameter,paramType,dataOra,value\n"; // Aggiornata l'intestazione CSV

                data.forEach(row => {
                    // Controlla se la data è in formato YYYY-MM-DD e la converte se necessario
                    let formattedDate = row.date;
                    const parts = formattedDate.split('-');
                    if (parts.length === 3 && parts[0].length === 4) {
                        formattedDate = parts.reverse().join('-');
                    }

                    // Aggiunge i nuovi campi
                    const paramType = row.paramType || row.parameter;
                    const dataOra = row.dataOra || `${formattedDate}, 00:00:00`; // Gestisce i dati vecchi

                    csvContent += `${row.player},${formattedDate},${row.parameter},${paramType},"${dataOra}",${row.value}\n`;
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `parametri_calcio_${new Date().toISOString().substring(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage("Dati scaricati con successo!", 'success');

            } catch (e) {
                console.error("Errore nel download dei dati:", e);
                showMessage("Errore durante il download dei dati.", 'error');
            }
        }

        // --- Funzione per l'invio dei dati a Google Sheets ---

        /**
         * Invia i dati a un'applicazione web di Google Sheets.
         * DEVI SOSTITUIRE 'YOUR_WEB_APP_URL' CON L'URL DELLA TUA APP SCRIPT.
         * La tua app script deve essere pubblicata come "web app" per funzionare.
         */

const GOOGLE_APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby-14UNnIFbdh9-O0kNXnJNENYGy7OceIIBNJ_tTa1lZQOWkAuHgvHIrL68TOadoYNv/exec"; <!-- v14.47 -->

        async function sendToGoogleSheets() {
            const WEB_APP_URL = GOOGLE_APPS_SCRIPT_URL; // <-- SOSTITUISCI QUESTO!
            const data = collectData();

            if (!data || data.length === 0) {
                showMessage("Nessun dato da inviare.", 'info');
                return;
            }

            /* 
            Sif (WEB_APP_URL === GOOGLE_APPS_SCRIPT_URL) {
                showMessage("Devi prima inserire l'URL della tua Web App di Google Sheets.", 'error');
                return;
            }
            */

            const sendButtonText = sendBtn.textContent;
            sendBtn.textContent = 'Invio...';
            sendBtn.disabled = true;

            let successfulSends = 0;
            let failedSends = 0;

            for (const record of data) {
                try {
                    const response = await fetch(WEB_APP_URL, {
                        method: 'POST',
                        mode: 'no-cors', // Necessario per evitare errori CORS, l'App Script gestirà la risposta
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(record)
                    });

                    // Dato che usiamo 'no-cors', non possiamo leggere la risposta.
                    // Assumiamo il successo a meno di un errore di rete.
                    successfulSends++;

                } catch (error) {
                    console.error('Errore durante l\'invio a Google Sheets:', error);
                    failedSends++;
                }
            }

            sendBtn.textContent = sendButtonText;
            sendBtn.disabled = false;

            if (failedSends === 0) {
                showMessage(`Dati inviati con successo! (${successfulSends} record)`, 'success');
            } else {
                showMessage(`Invio completato con ${successfulSends} successi e ${failedSends} fallimenti. Controlla la console per i dettagli.`, 'error');
            }
        }


        // --- Event Listeners dei bottoni ---
        saveLocalBtn.addEventListener('click', saveToLocal);
        downloadLocalBtn.addEventListener('click', downloadData);
        sendBtn.addEventListener('click', sendToGoogleSheets);

        // --- Esempio di Google Apps Script (da implementare nel tuo account) ---
        /*
        // Copia questo codice nel tuo Google Apps Script, salva, e pubblica come Web App
        function doPost(e) {
            const data = JSON.parse(e.postData.contents);
            const sheetName = data.parameter;
            const ss = SpreadsheetApp.getActiveSpreadsheet();

            let sheet = ss.getSheetByName(sheetName);
            if (!sheet) {
                sheet = ss.insertSheet(sheetName);
                sheet.appendRow(["player", "data", "parameter", "paramType", "dataOra", "value"]); // Aggiornate le intestazioni
            }

            sheet.appendRow([data.player, data.date, data.parameter, data.paramType, data.dataOra, data.value]); // La dataOra sarà una stringa
            // Se si desidera che la data venga formattata come data in Google Sheets, è necessario convertire la stringa.
            // Ad esempio:
            // sheet.getRange(sheet.getLastRow(), 2).setNumberFormat('dd/mm/yyyy'); // Formatta la colonna 'date'
            // sheet.getRange(sheet.getLastRow(), 5).setNumberFormat('dd/mm/yyyy hh:mm:ss'); // Formatta la colonna 'dataOra'

            return ContentService.createTextOutput("Successo").setMimeType(ContentService.MimeType.TEXT);
        }
        */

    </script>
</body>
</html>
