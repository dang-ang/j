
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Grafico Parametri Giocatore</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      background-color: #f0f0f0;
    }
    h2 {
      color: #333;
    }
    select {
      margin-right: 1rem;
      padding: 0.5rem;
    }
    canvas {
      margin-top: 2rem;
      max-width: 800px;
    }
  </style>
</head>
<body>
  <h2>Visualizza Parametri Giocatore</h2>

  <label for="nomeGiocatore">Nome:</label>
  <select id="nomeGiocatore">
    <option>AGRIGOROAEI</option>
    <option>AIT</option>
    <option>ARCIDIACONO</option>
    <option>BARUZZI</option>
    <option>BENALLAL</option>
    <option>BUSHI</option>
    <option>CENTANNI</option>
    <option>FALZONI</option>
    <option>FARINA</option>
    <option>FORESTIERO</option>
    <option>GALLALA</option>
    <option>GEMINIANI</option>
    <option>GNOFFO</option>
    <option>GRANO</option>
    <option>GRECA</option>
    <option>GUEYE</option>
    <option>IANIGRO</option>
    <option>MASHA</option>
    <option>MHILLAJ</option>
    <option>NDOJ</option>
    <option>ZITOUNI</option>
    <option>GIORDANO</option>
    <option>LANZA</option>
    <!-- Aggiungi altri nomi se necessario -->
  </select>

  <label for="parametro">Parametro:</label>
  <select id="parametro">
    <option value="attendance">PRESENZE</option>
    <option value="rpe">Sforzo</option>
    <option value="recovery">Recupero</option>
    <option value="fatigue">Stanchezza</option>
  </select>

  <button onclick="caricaDati()">Genera Grafico</button>

  <canvas id="graficoParametri"></canvas>

  <script>
    // const endpoint = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec"; // Inserisci il tuo URL Web App
    const endpoint = "https://script.google.com/macros/s/AKfycby-14UNnIFbdh9-O0kNXnJNENYGy7OceIIBNJ_tTa1lZQOWkAuHgvHIrL68TOadoYNv/exec"; // Inserisci il tuo URL Web App
//  https://script.google.com/macros/s/AKfycby-14UNnIFbdh9-O0kNXnJNENYGy7OceIIBNJ_tTa1lZQOWkAuHgvHIrL68TOadoYNv/exec?player=BUSHI&parameter=rpe

async function caricaDati() {
  const nome = document.getElementById("nomeGiocatore").value;
  const parametro = document.getElementById("parametro").value;

 const url = ["rpe", "recovery", "fatigue"].includes(parametro)
  ? `${endpoint}?parameter=${parametro}`
  : `${endpoint}?player=${nome}&parameter=${parametro}`;


  try {
   // const response = await fetch(`${endpoint}?parameter=${parametro}`);
    const response = await fetch(url);
    const dati = await response.json();

    if (dati.error) {
      alert(dati.error);
      return;
    }

    const date = [];
    const valori = [];
    const target = [];
    const mediaPerData = {};
    const conteggioPerData = {};
    let titoloData = "";
    let titoloTeam = "";

    dati.forEach(entry => {
      const valoreNumerico = parseFloat(entry.valore);
      const targetNumerico = parseFloat(entry.Team);
      const data = entry.data;
      const player = entry.player;

      if (!isNaN(valoreNumerico)) {
        // Valori del giocatore selezionato
        if (player === nome) {
          date.push(data);
          valori.push(valoreNumerico);

          if (parametro === "attendance") {
            target.push(isNaN(targetNumerico) ? null : targetNumerico);
            if (!titoloData && entry._Data_) titoloData = entry._Data_;
            if (!titoloTeam && entry.Team) titoloTeam = entry.Team;
          }
        }

        // Calcolo media giornaliera
        if (!mediaPerData[data]) {
          mediaPerData[data] = 0;
          conteggioPerData[data] = 0;
        }
        mediaPerData[data] += valoreNumerico;
        conteggioPerData[data]++;
      }
    });

    const mediaGiornaliera = date.map(d => {
      const somma = mediaPerData[d];
      const count = conteggioPerData[d];
      return count > 0 ? somma / count : null;
    });

    // Disegna primo grafico
    disegnaGraficoPrincipale(date, valori, target, parametro, nome, `${titoloTeam} ${titoloData}`);

    // Se non Ã¨ attendance, disegna anche il grafico della media
    if (["rpe", "recovery", "fatigue"].includes(parametro)) {
      disegnaGraficoMedia(date, mediaGiornaliera, parametro);
    }
  } catch (error) {
    console.error("Errore nel recupero dei dati:", error);
    alert("Errore nel caricamento dei dati.");
  }
}

function disegnaGraficoPrincipale(date, valori, target, parametro, nome, titolo) {
  const ctx = document.getElementById("graficoParametri").getContext("2d");
  if (window.grafico) window.grafico.destroy();

  const datasets = [{
    label: `${nome}`,
    data: valori,
    type: "bar",
    backgroundColor: "rgba(54, 162, 235, 0.6)",
    borderColor: "rgba(54, 162, 235, 1)",
    borderWidth: 1
  }];

  if (parametro === "attendance" && target.length > 0) {
    const coloriTarget = target.map((t, i) => {
      const v = valori[i];
      if (t === null || v === null) return "rgba(200,200,200,0.5)";
      return v < t ? "rgba(255, 0, 0, 1)" : "rgba(0, 200, 0, 1)";
    });

    datasets.push({
      label: "Target",
      data: target,
      type: "line",
      showLine: false,
      pointStyle: "circle",
      pointRadius: 7,
      pointBackgroundColor: coloriTarget,
      pointBorderColor: coloriTarget,
      borderWidth: 0
    });
  }

  window.grafico = new Chart(ctx, {
    type: "bar",
    data: {
      labels: date,
      datasets: datasets
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: parametro === "attendance" ? `Presenze - ${titolo}` : `${parametro} - ${nome}`,
          font: { size: 18 }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const valore = context.raw;
              return valore === null ? "Dato mancante" : `${context.dataset.label}: ${valore}`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: parametro }
        },
        x: {
          title: { display: true, text: "Data" }
        }
      }
    }
  });
}

function disegnaGraficoMedia(date, mediaGiornaliera, parametro) {
  let canvas = document.getElementById("graficoMedia");
  if (!canvas) {
    canvas = document.createElement("canvas");
    canvas.id = "graficoMedia";
    canvas.style.marginTop = "3rem";
    canvas.style.maxWidth = "900px";
    document.body.appendChild(canvas);
  }

  const ctx = canvas.getContext("2d");
  if (window.graficoMedia) window.graficoMedia.destroy();

  window.graficoMedia = new Chart(ctx, {
    type: "line",
    data: {
      labels: date,
      datasets: [{
        label: `Media Squadra - ${parametro}`,
        data: mediaGiornaliera,
        borderColor: "rgba(255, 165, 0, 1)",
        backgroundColor: "rgba(255, 165, 0, 0.2)",
        borderWidth: 2,
        pointRadius: 4,
        fill: false
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: `Media Giornaliera - ${parametro}`,
          font: { size: 18 }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const valore = context.raw;
              return valore === null ? "Dato mancante" : `Media: ${valore.toFixed(2)}`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: parametro }
        },
        x: {
          title: { display: true, text: "Data" }
        }
      }
    }
  });
}


  </script>
</body>
</html>